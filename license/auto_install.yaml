#!/bin/bash
# ==========================================================
# Proxmox VM Build Script for Carbon Black EDR on Rocky Linux
# Stores Rocky image in /var/lib/vz/template/qcow2 and VM disks in local-lvm
# Usage:
#   ./auto_install_EDR.sh <VMID> <hostname> <ip/cidr>
# Example:
#   ./auto_install_EDR.sh 202 cbresponse2 192.168.1.30/24
# ==========================================================
# curl -sSL -H "Cache-Control: no-cache "https://raw.githubusercontent.com/RockAfeller2013/EDR_Install/refs/heads/main/license/auto_install_EDR.sh | bash -s -- 203 cbresponse2 192.168.1.52/24

set -e

# --- Input Validation ---
if [ -z "$1" ]; then
  echo "Usage: $0 <VMID> <hostname> <ip/cidr>"
  exit 1
fi

VMID="$1"
HOSTNAME="${2:-cbresponse}"
IP_ADDR="${3:-192.168.1.30/24}"

# --- Defaults ---
VM_NAME="${HOSTNAME}-${VMID}"
MEMORY="32768"
CORES="4"
BRIDGE="vmbr0"
GATEWAY="192.168.1.99"
NAMESERVERS="1.1.1.1,8.8.8.8"
STORAGE="local-lvm"

TEMPLATE_STORAGE="local"
TEMPLATE_DIR="/var/lib/vz/template/qcow2"
QCOW_NAME="Rocky-8-GenericCloud-Base.latest.x86_64.qcow2"
QCOW_PATH="${TEMPLATE_DIR}/${QCOW_NAME}"
ROCKY_URL="https://dl.rockylinux.org/pub/rocky/8/images/x86_64/${QCOW_NAME}"
CLOUDINIT_SNIPPET="/var/lib/vz/snippets/auto_install.yaml"
CLOUDINIT_URL="https://raw.githubusercontent.com/RockAfeller2013/EDR_Install/refs/heads/main/license/auto_install.yaml"

echo "==========================================="
echo " Proxmox VM Build Script"
echo "-------------------------------------------"
echo " VMID:       ${VMID}"
echo " Hostname:   ${HOSTNAME}"
echo " IP Address: ${IP_ADDR}"
echo " Gateway:    ${GATEWAY}"
echo "==========================================="

# --- Ensure template dir exists ---
mkdir -p "$TEMPLATE_DIR"

# --- Download Rocky Linux QCOW2 image if missing ---
if [ ! -f "$QCOW_PATH" ]; then
  echo "[+] Downloading Rocky Linux 8 Cloud image..."
  curl -fsSL -o "$QCOW_PATH" "$ROCKY_URL"
else
  echo "[=] Using existing Rocky Linux image at ${QCOW_PATH}"
fi

# --- Download Cloud-init snippet from correct URL ---
if [ ! -f "$CLOUDINIT_SNIPPET" ]; then
  echo "[+] Downloading Cloud-init configuration from GitHub..."
  curl -fsSL -o "$CLOUDINIT_SNIPPET" "$CLOUDINIT_URL"
else
  echo "[=] Using existing Cloud-init snippet at ${CLOUDINIT_SNIPPET}"
fi

# --- Create the VM ---
echo "[+] Creating VM ID: ${VMID}"
qm create "$VMID" \
  --name "$VM_NAME" \
  --memory "$MEMORY" \
  --cores "$CORES" \
  --net0 virtio,bridge="$BRIDGE" \
  --scsihw virtio-scsi-pci \
  --ostype l26 \
  --cpu host \
  --serial0 socket \
  --agent 1 \
  --boot order=scsi0

# --- Import the QCOW2 disk to local-lvm ---
echo "[+] Importing QCOW2 disk into ${STORAGE}..."
qm importdisk "$VMID" "$QCOW_PATH" "$STORAGE"

# --- Configure disk and cloud-init ---
echo "[+] Attaching disk and Cloud-init configuration..."
qm set "$VMID" --scsi0 "$STORAGE:vm-${VMID}-disk-0"
qm set "$VMID" --ide2 "$TEMPLATE_STORAGE:cloudinit"
qm set "$VMID" --boot order=scsi0
qm set "$VMID" --cicustom "user=local:snippets/auto_install.yaml"
qm set "$VMID" --nameserver "$NAMESERVERS"
qm set "$VMID" --ipconfig0 "ip=${IP_ADDR},gw=${GATEWAY}"
qm set "$VMID" --ciuser root --cipassword Password1!
# qm set "$VMID" --hostname "$HOSTNAME"

# --- Update Cloud-init ---
echo "[+] Updating Cloud-init..."
qm cloudinit update "$VMID"

# --- Show VM configuration ---
echo "[+] VM Configuration complete:"
qm config "$VMID"

echo "âœ… VM ${VMID} (${VM_NAME}) ready to start."
echo "Use 'qm start ${VMID}' to boot the VM."
